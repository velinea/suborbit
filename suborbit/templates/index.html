{% extends "base.html" %}

{% block title %}SubOrbit{% endblock %}

{% block content %}
<!-- Sidebar / Filters -->
<aside class="md:w-1/4 overflow-y-auto bg-white/10 backdrop-blur p-2 rounded-xl shadow-lg space-23">
    <h2 class="text-lg font-semibold mb-2">Filters</h2>

    <!-- Main form with filters -->
    <form id="runForm" method="post" action="{{ url_for('core.start') }}" class="space-y-2">

        <div class="relative">
            <!-- Label row with info icon -->

            <div class="relative mb-4">
                <div class="flex items-center justify-between">
                    <label class="block text-sm">Trakt Source (optional)</label>
                    <button id="trakt-login-btn" type="button"
                        class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">
                        üîë Login with Trakt
                    </button>

                    <div id="trakt-login-popup"
                        class="hidden absolute right-0 mt-2 w-80 bg-gray-800 text-gray-200 text-sm p-4 rounded-lg shadow-lg z-50">
                        <p class="font-bold mb-2">Connect to Trakt</p>
                        <p class="text-xs mb-3">Click below to authorize SubOrbit to access your private lists.</p>
                        <button id="start-trakt-auth" type="button"
                            class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-xs w-full">Start
                            Authentication</button>
                        <div id="trakt-auth-status" class="text-xs mt-2"></div>
                    </div>


                    <button id="trakt-btn" type="button"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                        + Trakt List
                    </button>
                </div>

                <!-- Hidden inputs for the backend -->
                <input type="hidden" name="trakt_user" id="trakt_user">
                <input type="hidden" name="trakt_list" id="trakt_list">

                <!-- Popup modal -->
                <div id="trakt-popup"
                    class="hidden absolute right-0 mt-2 w-72 bg-gray-800 text-gray-200 text-sm p-4 rounded-lg shadow-lg z-50">
                    <p class="font-bold mb-2">Enter Trakt list details:</p>
                    <label class="block mb-1 text-xs">Username:</label>
                    <input id="trakt-user-input" type="text" placeholder="e.g. cooluser"
                        class="w-full p-1 mb-2 rounded text-black">
                    <label class="block mb-1 text-xs">List name:</label>
                    <input id="trakt-list-input" type="text" placeholder="e.g. watchlist"
                        class="w-full p-1 mb-3 rounded text-black">
                    <div class="flex justify-end gap-2">
                        <button id="trakt-cancel"
                            class="bg-gray-600 hover:bg-gray-700 px-2 py-1 rounded text-xs">Cancel</button>
                        <button id="trakt-save"
                            class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-xs">Save</button>
                    </div>
                </div>
            </div>



            <div class="flex items-center justify-between mb-1">
                <label class="block text-sm">Genres (comma separated)</label>

                <button id="genres-info-btn" type="button"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">
                    + Genres
                </button>
            </div>
            <!-- Free text input -->
            <input type="text" name="genres" placeholder="e.g. sci-fi, drama, !action"
                class="persist w-full p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">

            <p class="text-xs text-gray-400 mt-1">
                Prefix with <code>!</code> to exclude (e.g. <code>!horror</code>).
            </p>

            <!-- Popup with dynamic genre list -->
            <div id="genres-popup"
                class="hidden absolute right-0 mt-2 w-64 bg-gray-800 text-gray-200 text-sm p-3 rounded-lg shadow-lg z-50">
                <p class="font-bold mb-2">Available Genres (click to add / toggle exclude):</p>
                <div id="genres-list" class="flex flex-wrap gap-2"></div>
            </div>
        </div>


        <div class="flex justify-between">
            <label class="block p-2">Start Year</label>
            <input type="number" name="start_year" value="{{ start_year }}" required
                class="persist w-1/4 p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
            <label class="block p-2">End Year</label>
            <input type="number" name="end_year" value="{{ end_year }}" required
                class="persist w-1/4 p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex">
            <label class="w-3/4 p-2">Min TMDB Rating</label>
            <input type="number" step="0.1" name="min_tmdb" value="{{ min_tmdb }}" required
                class="persist w-1/4 p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex">
            <label class="w-3/4 p-2">Min IMDB Rating</label>
            <input type="number" step="0.1" name="min_imdb" value="{{ min_imdb }}" required
                class="persist w-1/4 p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex">
            <label class="w-3/4 p-2">Min RT Score</label>
            <input type="number" name="min_rt" value="{{ min_rt }}" required
                class="persist w-1/4 p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex">
            <label class="w-3/4 p-2">Min TMDB/IMDB Votes</label>
            <input type="number" name="min_vote_count" value="{{ min_vote_count }}" required
                class="persist w-1/4 p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex">
            <label class="w-3/4 p-2">Max Movies per Run</label>
            <input type="number" name="max_movies" value="{{ max_movies }}" required
                class="persist w-1/4 p-2 rounded-lg text-black focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="flex">
            <label class="w-1/2 p-2">Subtitle Language</label>
            <p id="langHint" class="w-1/4 text-xs text-red-500 opacity-0 transition-opacity duration-200">
                Enter a valid 2-letter language code (e.g. en, fr, es)
            </p>

            <input id="subtitle_lang" name="subtitle_lang" type="text" maxlength="2"
                class="persist w-1/4 rounded-lg p-2 text-gray-900 dark:text-gray-100 uppercase tracking-wider focus:border-blue-500 focus:ring-blue-500 transition"
                placeholder="en" value="{{ subtitle_lang }}" />
        </div>

        <div class="flex justify-between">
            <div class="flex w-1/3 items-center mx-2">
                <input type="checkbox" name="randomize" value="1" {% if randomize %}checked{% endif %} id="randbox"
                    class="persist mr-2 w-5 h-5 text-blue-600 rounded">
                <label for="randbox">Randomize selection</label>
            </div>
            <div class="flex w-1/2 justify-end">
                <button type="button" id="reset-filters"
                    class="w-full bg-gray-600 hover:bg-gray-800 text-white font-semibold py-2 px-4 rounded-lg transition">
                    Reset Filters
                </button>
            </div>
        </div>
    </form>
</aside>

<!-- Main Content -->
<section class="flex-1 flex flex-col md:overflow-hidden overflow-y-auto gap-2">
    <!-- Global loading overlay -->
    <div id="loading-overlay class=" hidden"></div>
    <!--         class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-center text-white">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-blue-500 mx-auto mb-3"></div>
            <p class="text-sm">Starting discovery‚Ä¶</p>
        </div>
        </div>
 -->
    <section class="my-2">
        <div class="flex items-center justify-between mb-2">
            <h2 class="text-lg font-semibold">Recently Added</h2>
            <button id="refresh-posters" class="text-sm text-blue-400 hover:text-blue-300 transition">
                ‚ü≥ Refresh
            </button>
        </div>

        <!-- Single-row horizontal carousel -->
        <div id="poster-carousel" class="flex space-x-4 overflow-x-auto pb-2 snap-x snap-mandatory scroll-smooth">
        </div>

        <script>
            async function loadRecent() {
                const div = document.getElementById("poster-carousel");
                div.innerHTML = "<p class='text-gray-400 text-sm'>Loading...</p>";

                try {
                    const res = await fetch("/api/radarr/recent");
                    const data = await res.json();
                    div.innerHTML = "";
                    div.classList.add("transition-opacity", "duration-300", "opacity-0");
                    requestAnimationFrame(() => div.classList.replace("opacity-0", "opacity-100"));

                    if (data.error) {
                        div.innerHTML = `<p class='text-sm text-red-400'>${data.error}</p>`;
                        return;
                    }

                    for (const m of data) {
                        if (!m.poster) continue;

                        const year = m.year || "‚Äî";
                        const rating = m.rating ? `‚≠ê ${m.rating.toFixed(1)}` : "‚≠ê ‚Äî";
                        const overview = m.overview
                            ? m.overview.replace(/"/g, "&quot;").substring(0, 300)
                            : "No description available.";

                        const card = document.createElement("div");
                        card.className = "relative group h-64 w-44 flex-shrink-0 cursor-pointer snap-start";

                        card.innerHTML = `
        <!-- Main link (poster -> Radarr) -->
        <a href="${m.radarr || '#'}" target="_blank" rel="noopener noreferrer">
          <img src="${m.poster}" alt="${m.title}"
               class="h-64 w-44 object-cover rounded-lg shadow-md opacity-100 transition
                      group-hover:opacity-70 animate-fadeIn">
        </a>

        <!-- Static info bar -->
        <div class="absolute bottom-0 left-0 right-0 bg-gray-900/80 text-gray-100 text-xs p-2 rounded-b-lg">
          <p class="font-semibold text-sm truncate">${m.title}</p>
          <p class="text-yellow-400 text-xs mt-0.5">${year} &nbsp; ${rating}</p>
        </div>

        <!-- Hover overview (now click-through and semi-transparent) -->
        <div class="absolute inset-0 bg-gray-900/80 text-gray-100 text-xs p-3 rounded-lg opacity-0
                    group-hover:opacity-100 transition flex flex-col justify-end pointer-events-none">
          <p class="font-semibold text-sm mb-1 truncate">${m.title}</p>
          <p class="text-yellow-400 text-xs mb-2">${year} &nbsp; ${rating}</p>
          <p class="leading-snug line-clamp-6">${overview}</p>
        </div>

        <!-- Overlay icons -->
        <div class="absolute top-1 right-1 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
          ${m.tmdb ? `
            <a href="${m.tmdb}" target="_blank" rel="noopener noreferrer"
               class="bg-gray-900/70 hover:bg-gray-900/90 rounded p-1 shadow">
               <img src="/static/icons/tmdb.png" class="h-4 w-4" alt="TMDB">
            </a>` : ""}
          ${m.imdb ? `
            <a href="${m.imdb}" target="_blank" rel="noopener noreferrer"
               class="bg-gray-900/70 hover:bg-gray-900/90 rounded p-1 shadow">
               <img src="/static/icons/imdb.png" class="h-4 w-4" alt="IMDb">
            </a>` : ""}
        </div>
      `;

                        // Optional: small staggered fade-in
                        card.style.animationDelay = `${Math.random() * 0.3}s`;

                        div.appendChild(card);
                    }
                } catch (e) {
                    console.error("Radarr fetch failed:", e);
                    div.innerHTML = `<p class='text-red-400 text-sm'>Error loading posters.</p>`;
                }
            }

            loadRecent();
            document.getElementById("refresh-posters")?.addEventListener("click", loadRecent);
        </script>

    </section>

    <!-- Results (future movies list) -->
    {% if movies %}
    <div class="bg-white/10 p-2 rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-2">Movies</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for movie in movies %}
            <div class="bg-white/20 p-3 rounded-lg">
                <p class="font-bold">{{ movie.title }}</p>
                <p class="text-sm text-gray-300">Rating: {{ movie.rating }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Logs (status + controls + output) -->
    <div class="flex-1 flex flex-col overflow-hidden bg-white/10 p-2 rounded-lg shadow">

        <!-- Header row: status + controls -->
        <div class="flex flex-row items-center justify-between mb-2">
            <!-- Left side: Status indicator -->
            <div class="flex items-center gap-2">
                <div id="status-dot"
                    class="inline-block w-3 h-3 rounded-full bg-gray-500 transition-all duration-300 shadow-sm"></div>
                <span id="status-text" class="text-sm text-gray-400">Idle</span>
            </div>

            <!-- Right side: Controls -->
            <div class="flex items-center gap-3">
                <label class="flex items-center gap-1 text-xs text-gray-400">
                    <input type="checkbox" id="autoscroll" checked class="w-4 h-4">
                    Auto-scroll
                </label>

                <form id="stop-form" method="post" action="/stop" style="display:none">
                    <button type="submit" id="stop-btn"
                        class="bg-red-600 hover:bg-red-700 text-white text-sm font-medium px-3 py-1.5 rounded-lg transition">
                        Stop
                    </button>
                </form>

                <button id="start-btn" type="button"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-3 py-1.5 rounded-lg transition">
                    Start
                </button>
            </div>
        </div>

        <!-- Log output -->
        <div id="log"
            class="flex-1 overflow-y-auto bg-black text-green-400 p-3 rounded-lg font-mono text-sm leading-snug">
        </div>
    </div>

</section>
{% endblock %}